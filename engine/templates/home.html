{% extends "base.html" %}
{% load static %}

{% block title %}Inventory | STOCKBRAIN{% endblock %}

{% block content %}
{{ can_edit|json_script:"can-edit-flag" }}
<script>
    window.CAN_EDIT = JSON.parse(
        document.getElementById("can-edit-flag").textContent
    );
</script>

<div class="sb-card" data-total-count="{{ item_count }}">

    <!-- ===================================== -->
    <!--        TOP BAR: PAGE SIZE + PAGER     -->
    <!-- ===================================== -->
    <div class="sb-home-controls" style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px;">

        <!-- PAGE SIZE DROPDOWN -->
        {% if not rack_filter %}
            <div class="sb-page-size-control" style="display:flex; align-items:center; gap:6px;">
                <label for="page-size-select">
                    Rows per page:
                </label>
                <select id="page-size-select"
                        class="sb-page-size-select"
                        name="page_size">
                    {% for opt in page_size_choices %}
                        {% if opt == "all" %}
                            <option value="all"
                                    {% if page_size == "all" %}selected{% endif %}>
                                All
                            </option>
                        {% else %}
                            <option value="{{ opt }}"
                                    {% if page_size == opt %}selected{% endif %}>
                                {{ opt }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        {% else %}
            <div class="sb-page-size-control">
                <span class="sb-rack-selection-info">
                    {{ selected_rack_count|default:"0" }} items selected in rack {{ rack_filter }}
                </span>
            </div>
        {% endif %}

        <!-- SEARCH BAR -->
        <div class="sb-search-control" style="display:flex; align-items:center; gap:6px; flex:1; min-width:280px;">
            <input type="text"
                   id="sb-search-input"
                   class="sb-search-input"
                   placeholder="Search..."
                   value="{{ search_query|default:'' }}">
            <div class="sb-search-buttons" style="display:flex; gap:6px; flex-wrap:wrap;">
                <button type="button" class="sb-btn sb-search-primary" id="sb-search-btn" aria-label="Search">
                    <span class="sb-search-icon">&#128269;</span>
                </button>
                <button type="button" class="sb-btn sb-adv-search" id="sb-advanced-search-btn">
                    <span class="sb-search-icon">&#128269;</span>&nbsp;Advanced
                </button>
                <button type="button" class="sb-btn sb-btn-clear" id="sb-search-clear-btn">Clear</button>
                <button type="button" class="sb-btn sb-btn-clear-strong" id="sb-search-clear-all-btn">Clear all</button>
            </div>
        </div>

        {% if can_edit or is_purchase_admin %}
        <div class="sb-add-item-wrapper" style="flex:1; display:flex; justify-content:center;">
            <button type="button" id="sb-add-item-btn" class="sb-add-item-btn">
                <span class="sb-search-icon sb-plus-icon">+</span>
                <span>item</span>
            </button>
        </div>
        {% endif %}

        <!-- PAGER -->
        {% if is_paginated %}
            <nav class="sb-pagination"
                 data-current-page="{{ current_page_number }}"
                 data-page-size="{{ page_size }}">

                {# FIRST << #}
                <a href="?page=1
                    {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                    {% if sort_field %}&sort={{ sort_field }}{% endif %}
                    {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                   class="sb-page-link sb-page-first"
                   data-page="1">&laquo;</a>

                {# PREV < #}
                {% if current_page_number > 1 %}
                    <a href="?page={{ current_page_number|add:'-1' }}
                        {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                        {% if sort_field %}&sort={{ sort_field }}{% endif %}
                        {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                       class="sb-page-link sb-page-prev"
                       data-page="{{ current_page_number|add:'-1' }}">&lsaquo;</a>
                {% else %}
                    <span class="sb-page-link sb-page-disabled">&lsaquo;</span>
                {% endif %}

                {# ALWAYS SHOW 1 #}
                {% if current_page_number == 1 %}
                    <span class="sb-page-link sb-page-current" data-page="1">1</span>
                {% else %}
                    <a href="?page=1
                        {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                        {% if sort_field %}&sort={{ sort_field }}{% endif %}
                        {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                       class="sb-page-link"
                       data-page="1">1</a>
                {% endif %}

                {% if show_first_ellipsis %}
                    <span class="sb-page-link sb-page-ellipsis">â€¦</span>
                {% endif %}

                {# SMART NUMBERS #}
                {% for num in page_numbers %}
                    {% if num > 1 and num < num_pages %}
                        {% if num == current_page_number %}
                            <span class="sb-page-link sb-page-current" data-page="{{ num }}">{{ num }}</span>
                        {% else %}
                            <a href="?page={{ num }}
                                {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                                {% if sort_field %}&sort={{ sort_field }}{% endif %}
                                {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                               class="sb-page-link"
                               data-page="{{ num }}">{{ num }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if show_last_ellipsis %}
                    <span class="sb-page-link sb-page-ellipsis">â€¦</span>
                {% endif %}

                {% if num_pages > 1 %}
                    {% if current_page_number == num_pages %}
                        <span class="sb-page-link sb-page-current" data-page="{{ num_pages }}">{{ num_pages }}</span>
                    {% else %}
                        <a href="?page={{ num_pages }}
                            {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                            {% if sort_field %}&sort={{ sort_field }}{% endif %}
                            {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                           class="sb-page-link"
                           data-page="{{ num_pages }}">{{ num_pages }}</a>
                    {% endif %}
                {% endif %}

                {# NEXT > #}
                {% if current_page_number < num_pages %}
                    <a href="?page={{ current_page_number|add:'1' }}
                        {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                        {% if sort_field %}&sort={{ sort_field }}{% endif %}
                        {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                       class="sb-page-link sb-page-next"
                       data-page="{{ current_page_number|add:'1' }}">&rsaquo;</a>
                {% else %}
                    <span class="sb-page-link sb-page-disabled">&rsaquo;</span>
                {% endif %}

                {# LAST >> #}
                <a href="?page={{ num_pages }}
                    {% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}
                    {% if sort_field %}&sort={{ sort_field }}{% endif %}
                    {% if sort_dir %}&dir={{ sort_dir }}{% endif %}"
                   class="sb-page-link sb-page-last"
                   data-page="{{ num_pages }}">&raquo;</a>
            </nav>
        {% endif %}
    </div>

    <!-- ===================================== -->
    <!--                TABLE                  -->
    <!-- ===================================== -->

    <div class="sb-table-wrapper">
        <div class="sb-progress">
            <div class="sb-progress-bar"></div>
        </div>
        <table class="sb-table"
               data-current-sort="{{ sort_field }}"
               data-current-dir="{{ sort_dir }}"
               data-rack-filter="{{ rack_filter|default:'' }}"
               data-group-filter="{{ group_filter|default:'' }}"
               data-condition-filter="{{ condition_filter|default:'' }}"
               data-search="{{ search_query|default:'' }}">
            <thead>
            <tr class="sb-header-filter-row">
                <th class="col-location">
                    <select class="sb-filter-rack">
                        <option value="" {% if not rack_filter %}selected{% endif %}>------</option>
                        {% for r in rack_filter_values %}
                            <option value="{{ r }}" {% if rack_filter == r %}selected{% endif %}>{{ r }}-X-X</option>
                        {% endfor %}
                    </select>
                </th>
                <th class="col-group">
                    <select class="sb-filter-group">
                        <option value="" {% if not group_filter %}selected{% endif %}>------</option>
                        {% for g in groups %}
                            <option value="{{ g.id }}" {% if group_filter == g.id %}selected{% endif %}>{{ g.name }}</option>
                        {% endfor %}
                    </select>
                </th>
                <th class="col-name"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-partdesc"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-partnum"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-dcm"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-oemname"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-oemnum"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% if is_purchase_admin or 'vendor' not in restricted_fields %}
                    <th class="col-vendor"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% endif %}
                {% if is_purchase_admin or 'source_location' not in restricted_fields %}
                    <th class="col-sourceloc"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% endif %}
                <th class="col-units"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% if is_purchase_admin or 'quantity_in_stock' not in restricted_fields %}
                    <th class="col-instock"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% endif %}
                {% if is_purchase_admin or 'price' not in restricted_fields %}
                    <th class="col-price"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% endif %}
                {% if is_purchase_admin or 'reorder_level' not in restricted_fields %}
                    <th class="col-reorderlevel"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% endif %}
                <th class="col-rt"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% if is_purchase_admin or 'quantity_in_reorder' not in restricted_fields %}
                    <th class="col-qtyreorder"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% endif %}
                <th class="col-condition">
                    <select class="sb-filter-condition">
                        <option value="" {% if not condition_filter %}selected{% endif %}>------</option>
                        {% for val,label in condition_choices %}
                            <option value="{{ val }}" {% if condition_filter == val %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </th>
                <th class="col-disc"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-rev"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-fav"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-note"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                <th class="col-reorder"><span class="sb-filter-icon" aria-label="Toggle search"></span></th>
                {% if can_edit %}
                    <th class="col-trash"></th>
                {% endif %}
            </tr>
            <tr>
                {# LOCATION (computed) #}
                {% with col=columns.location %}
                    <th class="col-location sb-sortable-header"
                        data-sort-field="location"
                        title="{{ col.full_label|default:'Location' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Location' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'location' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'location' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# GROUP (nigdy nie ukrywamy, sortowalne) #}
                {% with col=columns.group %}
                    <th class="col-group sb-sortable-header"
                        data-sort-field="group"
                        title="{{ col.full_label|default:'Group' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Group' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'group' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'group' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# NAME (sortowalne) #}
                {% with col=columns.name %}
                    <th class="col-name sb-sortable-header"
                        data-sort-field="name"
                        title="{{ col.full_label|default:'Name' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Name' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'name' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'name' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# DESCRIPTION #}
                {% with col=columns.part_description %}
                    <th class="col-partdesc sb-sortable-header"
                        data-sort-field="part_description"
                        title="{{ col.full_label|default:'Part Description' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Part Description' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'part_description' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'part_description' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# PART NUMBER #}
                {% with col=columns.part_number %}
                    <th class="col-partnum sb-sortable-header"
                        data-sort-field="part_number"
                        title="{{ col.full_label|default:'Part Number' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Part Number' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'part_number' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'part_number' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# DCM #}
                {% with col=columns.dcm_number %}
                    <th class="col-dcm sb-sortable-header"
                        data-sort-field="dcm_number"
                        title="{{ col.full_label|default:'DCM Number' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'DCM NUMBER' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'dcm_number' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'dcm_number' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# OEM NAME #}
                {% with col=columns.oem_name %}
                    <th class="col-oemname sb-sortable-header"
                        data-sort-field="oem_name"
                        title="{{ col.full_label|default:'OEM Name' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'OEM Name' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'oem_name' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'oem_name' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# OEM NUMBER #}
                {% with col=columns.oem_number %}
                    <th class="col-oemnum sb-sortable-header"
                        data-sort-field="oem_number"
                        title="{{ col.full_label|default:'OEM Number' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'OEM Number' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'oem_number' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'oem_number' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# VENDOR â€“ moÅ¼e byÄ‡ restricted #}
                {% with col=columns.vendor %}
                    {% if is_purchase_admin or 'vendor' not in restricted_fields %}
                        <th class="col-vendor sb-sortable-header"
                            data-sort-field="vendor"
                            title="{{ col.full_label|default:'Vendor' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                            <span class="sb-header-label">
                                {{ col.short_label|default:col.full_label|default:'Vendor' }}
                            </span>
                            <span class="sb-sort-arrow {% if sort_field == 'vendor' %}sb-sort-arrow--active{% endif %}">
                                {% if sort_field == 'vendor' %}
                                    {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% else %}
                                    â‡…
                                {% endif %}
                            </span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# SOURCE LOCATION â€“ moÅ¼e byÄ‡ restricted #}
                {% with col=columns.source_location %}
                    {% if is_purchase_admin or 'source_location' not in restricted_fields %}
                        <th class="col-sourceloc sb-sortable-header"
                            data-sort-field="source_location"
                            title="{{ col.full_label|default:'Source Location' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                            <span class="sb-header-label">
                                {{ col.short_label|default:col.full_label|default:'Source Location' }}
                            </span>
                            <span class="sb-sort-arrow {% if sort_field == 'source_location' %}sb-sort-arrow--active{% endif %}">
                                {% if sort_field == 'source_location' %}
                                    {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% else %}
                                    â‡…
                                {% endif %}
                            </span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# UNITS #}
                {% with col=columns.unit %}
                    <th class="col-units sb-sortable-header"
                        data-sort-field="unit"
                        title="{{ col.full_label|default:'Units' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Units' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'unit' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'unit' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# IN STOCK â€“ moÅ¼e byÄ‡ restricted #}
                {% with col=columns.quantity_in_stock %}
                    {% if is_purchase_admin or 'quantity_in_stock' not in restricted_fields %}
                        <th class="col-instock sb-sortable-header"
                            data-sort-field="quantity_in_stock"
                            title="{{ col.full_label|default:'In stock' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                            <span class="sb-header-label">
                                {{ col.short_label|default:col.full_label|default:'In stock' }}
                            </span>
                            <span class="sb-sort-arrow {% if sort_field == 'quantity_in_stock' %}sb-sort-arrow--active{% endif %}">
                                {% if sort_field == 'quantity_in_stock' %}
                                    {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% else %}
                                    â‡…
                                {% endif %}
                            </span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# PRICE â€“ moÅ¼e byÄ‡ restricted #}
                {% with col=columns.price %}
                    {% if is_purchase_admin or 'price' not in restricted_fields %}
                        <th class="col-price sb-sortable-header"
                            data-sort-field="price"
                            title="{{ col.full_label|default:'Price' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                            <span class="sb-header-label">
                                {{ col.short_label|default:col.full_label|default:'Price' }}
                            </span>
                            <span class="sb-sort-arrow {% if sort_field == 'price' %}sb-sort-arrow--active{% endif %}">
                                {% if sort_field == 'price' %}
                                    {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% else %}
                                    â‡…
                                {% endif %}
                            </span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# REORDER LEVEL â€“ moÅ¼e byÄ‡ restricted #}
                {% with col=columns.reorder_level %}
                    {% if is_purchase_admin or 'reorder_level' not in restricted_fields %}
                        <th class="col-reorderlevel sb-sortable-header"
                            data-sort-field="reorder_level"
                            title="{{ col.full_label|default:'Reorder level' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                            <span class="sb-header-label">{{ col.short_label|default:col.full_label|default:'Reorder level' }}</span>
                            <span class="sb-sort-arrow {% if sort_field == 'reorder_level' %}sb-sort-arrow--active{% endif %}">
                                {% if sort_field == 'reorder_level' %}
                                    {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% else %}
                                    â‡…
                                {% endif %}
                            </span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# RT DAYS #}
                {% with col=columns.reorder_time_days %}
                    <th class="col-rt sb-sortable-header"
                        data-sort-field="reorder_time_days"
                        title="{{ col.full_label|default:'Reorder Time in Days' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">{{ col.short_label|default:'RT' }}</span>
                        <span class="sb-sort-arrow {% if sort_field == 'reorder_time_days' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'reorder_time_days' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# QTY REORDER â€“ moÅ¼e byÄ‡ restricted #}
                {% with col=columns.quantity_in_reorder %}
                    {% if is_purchase_admin or 'quantity_in_reorder' not in restricted_fields %}
                        <th class="col-qtyreorder sb-sortable-header"
                            data-sort-field="quantity_in_reorder"
                            title="{{ col.full_label|default:'Quantity Reorder' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                            <span class="sb-header-label">{{ col.short_label|default:col.full_label|default:'Quantity Reorder' }}</span>
                            <span class="sb-sort-arrow {% if sort_field == 'quantity_in_reorder' %}sb-sort-arrow--active{% endif %}">
                                {% if sort_field == 'quantity_in_reorder' %}
                                    {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% else %}
                                    â‡…
                                {% endif %}
                            </span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# CONDITION #}
                {% with col=columns.condition_status %}
                    <th class="col-condition sb-sortable-header"
                        data-sort-field="condition_status"
                        title="{{ col.full_label|default:'Condition status' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">
                            {{ col.short_label|default:col.full_label|default:'Condition' }}
                        </span>
                        <span class="sb-sort-arrow {% if sort_field == 'condition_status' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'condition_status' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# DISC #}
                {% with col=columns.discontinued %}
                    <th class="col-disc sb-sortable-header"
                        data-sort-field="discontinued"
                        title="{{ col.full_label|default:'Discontinued' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">{{ col.short_label|default:'Disc.' }}</span>
                        <span class="sb-sort-arrow {% if sort_field == 'discontinued' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'discontinued' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# REV #}
                {% with col=columns.verify %}
                    <th class="col-rev sb-sortable-header"
                        data-sort-field="verify"
                        title="{{ col.full_label|default:'To Review / Verify' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">{{ col.short_label|default:'REV.' }}</span>
                        <span class="sb-sort-arrow {% if sort_field == 'verify' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'verify' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# FAVORITE #}
                {% with col=columns.favorite %}
                    <th class="col-fav sb-sortable-header"
                        data-sort-field="favorite"
                        title="{{ col.full_label|default:'Favorite' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">{{ col.short_label|default:'Fav' }}</span>
                        <span class="sb-sort-arrow {% if sort_field == 'favorite' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'favorite' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# USER NOTE #}
                {% with col=columns.note %}
                    <th class="col-note sb-sortable-header"
                        data-sort-field="note"
                        title="{{ col.full_label|default:'User Note' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">{{ col.short_label|default:'Note' }}</span>
                        <span class="sb-sort-arrow {% if sort_field == 'note' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'note' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {# REORDER FLAG #}
                {% with col=columns.for_reorder %}
                    <th class="col-reorder sb-sortable-header"
                        data-sort-field="for_reorder"
                        title="{{ col.full_label|default:'Reorder flag' }}{% if col.functional_description %} â€“ {{ col.functional_description }}{% endif %}">
                        <span class="sb-header-label">{{ col.short_label|default:'Reorder' }}</span>
                        <span class="sb-sort-arrow {% if sort_field == 'for_reorder' %}sb-sort-arrow--active{% endif %}">
                            {% if sort_field == 'for_reorder' %}
                                {% if sort_dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                            {% else %}
                                â‡…
                            {% endif %}
                        </span>
                    </th>
                {% endwith %}

                {% if can_edit %}
                    <th class="col-trash"></th>
                {% endif %}
            </tr>
            </thead>

            <tbody>
            {% for item in items %}

                {% with usermeta=item.meta_for_user.0 %}
                    <tr class="sb-row
                               {% if item.verify %} sb-row-verify{% endif %}
                               {% if item.discontinued %} sb-row-disc{% endif %}"
                        data-item-id="{{ item.id }}"
                        data-fav="{{ usermeta.favorite_color|default:'NONE' }}"
                        data-note="{{ usermeta.note|default:''|escape }}">
                {% endwith %}

                    <!-- LOCATION -->
                    <td class="col-location" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.rack }}-{{ item.shelf }}-{{ item.box }}">
                            {{ item.rack }}-{{ item.shelf }}-{{ item.box }}
                        </span>
                    </td>

                    <!-- GROUP -->
                    <td class="col-group">
                        <select class="group-select" data-item-id="{{ item.id }}">
                            {% for g in groups %}
                                <option value="{{ g.id }}" {% if item.group_id == g.id %}selected{% endif %}>
                                    {{ g.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- NAME -->
                    <td class="col-name inline" data-field="name" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.name }}">{{ item.name }}</span>
                    </td>

                    <!-- DESCRIPTION (HTML preview + Quill + inline-ready) -->
                    <td class="col-partdesc"
                        data-id="{{ item.id }}"
                        data-field="part_description">
                        <div class="sb-desc-container">
                            <div class="sb-desc-preview sb-multiline"
                                 title="{{ item.part_description|striptags }}">
                                {{ item.part_description|safe }}
                            </div>
                            <button type="button"
                                    class="sb-desc-edit-btn"
                                    data-id="{{ item.id }}"
                                    title="Open full editor for description">
                                <svg class="sb-icon-pencil" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path d="M12 20H5l2-7 9.5-9.5a2.1 2.1 0 0 1 3 3L10 16l-5 2" />
                                </svg>
                            </button>
                        </div>
                    </td>

                    <!-- PART NUMBER -->
                    <td class="col-partnum inline" data-field="part_number" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.part_number }}">{{ item.part_number }}</span>
                    </td>

                    <!-- DCM -->
                    <td class="col-dcm inline" data-field="dcm_number" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.dcm_number }}">{{ item.dcm_number }}</span>
                    </td>

                    <!-- OEM NAME -->
                    <td class="col-oemname inline" data-field="oem_name" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.oem_name }}">{{ item.oem_name }}</span>
                    </td>

                    <!-- OEM NUMBER -->
                    <td class="col-oemnum inline" data-field="oem_number" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.oem_number }}">{{ item.oem_number }}</span>
                    </td>

                    <!-- VENDOR -->
                    {% if is_purchase_admin or 'vendor' not in restricted_fields %}
                        <td class="col-vendor inline" data-field="vendor" data-id="{{ item.id }}">
                            <span class="sb-multiline" title="{{ item.vendor }}">{{ item.vendor }}</span>
                        </td>
                    {% endif %}

                    <!-- SOURCE LOCATION -->
                    {% if is_purchase_admin or 'source_location' not in restricted_fields %}
                        <td class="col-sourceloc inline" data-field="source_location" data-id="{{ item.id }}">
                            <span class="sb-multiline" title="{{ item.source_location }}">{{ item.source_location }}</span>
                        </td>
                    {% endif %}

                    <!-- UNITS -->
                    <td class="col-units">
                        <select class="unit-select" data-item-id="{{ item.id }}">
                            {% for u in units %}
                                <option value="{{ u.id }}" {% if item.unit_id == u.id %}selected{% endif %}>
                                    {{ u.code }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- IN STOCK -->
                    {% if is_purchase_admin or 'quantity_in_stock' not in restricted_fields %}
                        <td class="col-instock inline" data-field="quantity_in_stock" data-id="{{ item.id }}">
                            {{ item.quantity_in_stock }}
                        </td>
                    {% endif %}

                    <!-- PRICE -->
                    {% if is_purchase_admin or 'price' not in restricted_fields %}
                        <td class="col-price inline" data-field="price" data-id="{{ item.id }}">
                            {{ item.price }}
                        </td>
                    {% endif %}

                    <!-- REORDER LEVEL -->
                    {% if is_purchase_admin or 'reorder_level' not in restricted_fields %}
                        <td class="col-reorderlevel inline" data-field="reorder_level" data-id="{{ item.id }}">
                            {{ item.reorder_level }}
                        </td>
                    {% endif %}

                    <!-- RT DAYS -->
                    <td class="col-rt inline" data-field="reorder_time_days" data-id="{{ item.id }}">
                        {{ item.reorder_time_days }}
                    </td>

                    <!-- QTY REORDER -->
                    {% if is_purchase_admin or 'quantity_in_reorder' not in restricted_fields %}
                        <td class="col-qtyreorder inline" data-field="quantity_in_reorder" data-id="{{ item.id }}">
                            {{ item.quantity_in_reorder }}
                        </td>
                    {% endif %}

                    <!-- CONDITION DROPDOWN -->
                    <td class="col-condition">
                        <select class="condition-select" data-item-id="{{ item.id }}">
                            <option value="">---</option>
                            {% for value, label in condition_choices %}
                                <option value="{{ value }}" {% if item.condition_status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- DISC CHECKBOX -->
                    <td class="col-disc">
                        <input type="checkbox"
                               class="disc-checkbox"
                               data-item-id="{{ item.id }}"
                               {% if item.discontinued %}checked{% endif %}>
                    </td>

                    <!-- REV CHECKBOX -->
                    <td class="col-rev">
                        <input type="checkbox"
                               class="rev-checkbox"
                               data-item-id="{{ item.id }}"
                               {% if item.verify %}checked{% endif %}>
                    </td>

                    <!-- FAVORITE STAR (per-user) -->
                    {% with fav=item.meta_for_user.0.favorite_color|default:"NONE" %}
                        <td class="col-fav">
                            <span class="sb-favorite"
                                  data-item-id="{{ item.id }}"
                                  data-color="{{ fav }}">
                                {% if fav == "RED" or fav == "GREEN" or fav == "YELLOW" or fav == "BLUE" %}
                                    &#9733;
                                {% else %}
                                    &#9734;
                                {% endif %}
                            </span>
                        </td>
                    {% endwith %}

                    <!-- USER NOTE BUTTON (per-user) -->
                    {% with note=item.meta_for_user.0.note|default:"" %}
                        {% with plain_note=note|striptags %}
                            <td class="col-note"
                                data-item-id="{{ item.id }}"
                                data-field="note">
                                <div class="sb-note-container">
                                    <div class="sb-note-preview sb-multiline"
                                         title="{{ plain_note }}">
                                        {{ plain_note|truncatechars:200 }}
                                    </div>
                                    <button type="button"
                                            class="sb-note-btn{% if note %} sb-note-has-content{% endif %}"
                                            data-item-id="{{ item.id }}"
                                            data-note="{{ note|escape }}"
                                            data-has-note="{% if note %}1{% else %}0{% endif %}"
                                            title="Open full editor for your private note">
                                        <svg class="sb-icon-pencil" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                            <path d="M12 20H5l2-7 9.5-9.5a2.1 2.1 0 0 1 3 3L10 16l-5 2" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        {% endwith %}
                    {% endwith %}

                    <!-- REORDER FLAG -->
                    <td class="col-reorder">
                        {% if item.for_reorder %}
                            <span class="sb-tag sb-tag-warning">YES</span>
                        {% endif %}
                    </td>
                    {% if can_edit %}
                        <td class="col-trash">
                            <button type="button"
                                    class="sb-trash-btn"
                                    data-item-id="{{ item.id }}"
                                    data-loc="{{ item.rack }}-{{ item.shelf }}-{{ item.box }}"
                                    data-name="{{ item.name }}"
                                    data-qty="{{ item.quantity_in_stock }}"
                                    title="{{ item.rack }}-{{ item.shelf }}-{{ item.box }} | {{ item.name }} | {{ item.quantity_in_stock }}">
                                ðŸ—‘
                            </button>
                        </td>
                    {% endif %}

                </tr>
            {% empty %}
                <tr>
                    <td colspan="25">No inventory items yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if can_edit or is_purchase_admin %}
<!-- DELETE ITEM MODAL -->
<div id="sb-delete-modal" class="sb-modal" aria-hidden="true">
    <div class="sb-modal-dialog sb-delete-dialog">
        <div class="sb-modal-header">
            <div><strong>Delete item</strong></div>
            <div><button type="button" class="sb-modal-close" aria-label="Close">&times;</button></div>
        </div>
        <div class="sb-modal-body">
            <p>Delete:</p>
            <div class="sb-delete-summary">
                <div class="sb-delete-field">
                    <label>Location</label>
                    <div class="sb-delete-readonly" id="sb-del-loc"></div>
                </div>
                <div class="sb-delete-field">
                    <label>Name</label>
                    <div class="sb-delete-readonly" id="sb-del-name"></div>
                </div>
                <div class="sb-delete-field">
                    <label>Quantity in stock</label>
                    <div class="sb-delete-readonly" id="sb-del-qty"></div>
                </div>
            </div>
            <div class="sb-delete-field">
                <label for="sb-delete-password">Password</label>
                <input type="password" id="sb-delete-password" autocomplete="current-password">
            </div>
        </div>
        <div class="sb-modal-footer">
            <button type="button" class="sb-modal-cancel sb-delete-cancel">Cancel</button>
            <button type="button" class="sb-modal-save sb-delete-confirm" style="background:#d9534f;">Delete</button>
        </div>
    </div>
</div>

<!-- DELETE SUCCESS MODAL -->
<div id="sb-delete-success" class="sb-modal" aria-hidden="true">
    <div class="sb-modal-dialog sb-delete-dialog">
        <div class="sb-modal-header">
            <div><strong>Item deleted</strong></div>
        </div>
        <div class="sb-modal-body">
            <p>The item has been deleted.</p>
        </div>
        <div class="sb-modal-footer">
            <button type="button" class="sb-delete-ok">OK</button>
        </div>
    </div>
</div>
{% endif %}

{% if can_edit or is_purchase_admin %}
<!-- ADD ITEM MODAL -->
<div id="sb-add-item-modal" class="sb-modal" aria-hidden="true">
    <div class="sb-modal-dialog sb-add-item-dialog">
        <div class="sb-modal-header">
            <div>
                <strong>Add new item</strong>
            </div>
            <div>
                <button type="button" class="sb-modal-close" aria-label="Close">&times;</button>
            </div>
        </div>
        <div class="sb-modal-body">
            <form id="sb-add-item-form" class="sb-add-item-form">
                <div class="sb-add-row rsb-row">
                    {% with col=columns.rack %}
                        <div class="sb-add-field sb-mandatory">
                            <label>{{ col.full_label|default:col.field_name|default:"Rack" }} <span class="sb-mandatory-badge">mandatory</span></label>
                            <input type="text" name="rack" required>
                        </div>
                    {% endwith %}
                    {% with col=columns.shelf %}
                        <div class="sb-add-field sb-mandatory">
                            <label>{{ col.full_label|default:col.field_name|default:"Shelf" }} <span class="sb-mandatory-badge">mandatory</span></label>
                            <input type="text" name="shelf" required>
                        </div>
                    {% endwith %}
                    {% with col=columns.box %}
                        <div class="sb-add-field sb-mandatory">
                            <label>{{ col.full_label|default:col.field_name|default:"Box" }} <span class="sb-mandatory-badge">mandatory</span></label>
                            <input type="text" name="box" required>
                        </div>
                    {% endwith %}
                </div>

                {% with col=columns.group %}
                <div class="sb-add-field sb-mandatory">
                    <label>{{ col.full_label|default:col.field_name|default:"Group" }} <span class="sb-mandatory-badge">mandatory</span></label>
                    <select name="group_id" required>
                        {% for g in groups %}
                            <option value="{{ g.id }}">{{ g.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endwith %}

                {% with col=columns.name %}
                <div class="sb-add-field sb-mandatory">
                    <label>{{ col.full_label|default:col.field_name|default:"Name" }} <span class="sb-mandatory-badge">mandatory</span></label>
                    <input type="text" name="name" required>
                </div>
                {% endwith %}

                {% with col=columns.part_description %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"Part description" }}</label>
                    <textarea name="part_description" rows="3"></textarea>
                </div>
                {% endwith %}

                {% with col=columns.part_number %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"Part number" }}</label>
                    <input type="text" name="part_number">
                </div>
                {% endwith %}

                {% with col=columns.dcm_number %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"DCM" }}</label>
                    <input type="text" name="dcm_number">
                </div>
                {% endwith %}

                {% with col=columns.oem_name %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"OEM Name" }}</label>
                    <input type="text" name="oem_name">
                </div>
                {% endwith %}

                {% with col=columns.oem_number %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"OEM Number" }}</label>
                    <input type="text" name="oem_number">
                </div>
                {% endwith %}

                {% if is_purchase_admin or 'vendor' not in restricted_fields %}
                    {% with col=columns.vendor %}
                    <div class="sb-add-field">
                        <label>{{ col.full_label|default:col.field_name|default:"Vendor" }}</label>
                        <input type="text" name="vendor">
                    </div>
                    {% endwith %}
                {% endif %}

                {% if is_purchase_admin or 'source_location' not in restricted_fields %}
                    {% with col=columns.source_location %}
                    <div class="sb-add-field">
                        <label>{{ col.full_label|default:col.field_name|default:"Source location" }}</label>
                        <input type="text" name="source_location">
                    </div>
                    {% endwith %}
                {% endif %}

                <div class="sb-add-row rsb-row">
                    {% with col=columns.unit %}
                    <div class="sb-add-field sb-mandatory">
                        <label>{{ col.full_label|default:col.field_name|default:"Unit" }} <span class="sb-mandatory-badge">mandatory</span></label>
                        <select name="unit_id" required>
                            {% for u in units %}
                                <option value="{{ u.id }}">{{ u.code }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endwith %}

                    {% if is_purchase_admin or 'quantity_in_stock' not in restricted_fields %}
                        {% with col=columns.quantity_in_stock %}
                        <div class="sb-add-field sb-mandatory">
                            <label>{{ col.full_label|default:col.field_name|default:"Quantity in stock" }} <span class="sb-mandatory-badge">mandatory</span></label>
                            <input type="number" step="1" name="quantity_in_stock" required>
                        </div>
                        {% endwith %}
                    {% endif %}
                </div>

                {% if is_purchase_admin or 'price' not in restricted_fields %}
                    {% with col=columns.price %}
                    <div class="sb-add-field">
                        <label>{{ col.full_label|default:col.field_name|default:"Price" }}</label>
                        <input type="number" step="0.01" name="price">
                    </div>
                    {% endwith %}
                {% endif %}

                {% if is_purchase_admin or 'reorder_level' not in restricted_fields %}
                    {% with col=columns.reorder_level %}
                    <div class="sb-add-field">
                        <label>{{ col.full_label|default:col.field_name|default:"Reorder level" }}</label>
                        <input type="number" step="1" name="reorder_level">
                    </div>
                    {% endwith %}
                {% endif %}

                {% with col=columns.reorder_time_days %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"RT days" }}</label>
                    <input type="number" step="1" name="reorder_time_days">
                </div>
                {% endwith %}

                {% if is_purchase_admin or 'quantity_in_reorder' not in restricted_fields %}
                    {% with col=columns.quantity_in_reorder %}
                    <div class="sb-add-field">
                        <label>{{ col.full_label|default:col.field_name|default:"Qty reorder" }}</label>
                        <input type="number" step="1" name="quantity_in_reorder">
                    </div>
                    {% endwith %}
                {% endif %}

                {% with col=columns.condition_status %}
                <div class="sb-add-field">
                    <label>{{ col.full_label|default:col.field_name|default:"Condition" }}</label>
                    <select name="condition_status">
                        <option value="">---</option>
                        {% for value, label in condition_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endwith %}

                <div class="sb-add-row">
                    {% with col=columns.discontinued %}
                    <label class="sb-add-checkbox">
                        <input type="checkbox" name="discontinued">
                        <span>{{ col.full_label|default:col.field_name|default:"Discontinued" }}</span>
                    </label>
                    {% endwith %}

                    {% with col=columns.verify %}
                    <label class="sb-add-checkbox">
                        <input type="checkbox" name="verify">
                        <span>{{ col.full_label|default:col.field_name|default:"Verify" }}</span>
                    </label>
                    {% endwith %}
                </div>
            </form>
        </div>
        <div class="sb-modal-footer">
            <button type="button" class="sb-modal-save" data-mode="save">Save</button>
            <button type="button" class="sb-modal-save" data-mode="save-next">Save and next</button>
            <button type="button" class="sb-modal-cancel">Cancel</button>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
