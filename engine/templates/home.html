{% extends "base.html" %}
{% load static %}

{% block title %}Inventory | STOCKBRAIN{% endblock %}

{% block content %}
<script>
    window.CAN_EDIT = {{ can_edit|yesno:"true,false" }};
</script>

<div class="sb-card">

    <!-- ===================================== -->
    <!--        TOP BAR: PAGE SIZE + PAGER     -->
    <!-- ===================================== -->
    <div class="sb-home-controls" style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:10px;">

        <!-- PAGE SIZE DROPDOWN -->
        <div class="sb-page-size-control">
            <label for="page-size-select">
                Rows per page:
            </label>
            <select id="page-size-select"
                    class="sb-page-size-select"
                    name="page_size">
                {% for opt in page_size_choices %}
                    {% if opt == "all" %}
                        <option value="all"
                                {% if page_size == "all" %}selected{% endif %}>
                            All
                        </option>
                    {% else %}
                        <option value="{{ opt }}"
                                {% if page_size == opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- PAGER -->
        {% if is_paginated %}
            <nav class="sb-pagination"
                 data-current-page="{{ current_page_number }}"
                 data-page-size="{{ page_size }}">

                <!-- FIRST << -->
                <a href="?page=1{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                   class="sb-page-link sb-page-first"
                   data-page="1">&laquo;</a>

                <!-- PREV < -->
                {% if current_page_number > 1 %}
                    <a href="?page={{ current_page_number|add:'-1' }}{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                       class="sb-page-link sb-page-prev"
                       data-page="{{ current_page_number|add:'-1' }}">&lsaquo;</a>
                {% else %}
                    <span class="sb-page-link sb-page-disabled">&lsaquo;</span>
                {% endif %}

                <!-- ALWAYS SHOW 1 -->
                {% if current_page_number == 1 %}
                    <span class="sb-page-link sb-page-current" data-page="1">1</span>
                {% else %}
                    <a href="?page=1{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                       class="sb-page-link"
                       data-page="1">1</a>
                {% endif %}

                {% if show_first_ellipsis %}
                    <span class="sb-page-link sb-page-ellipsis">‚Ä¶</span>
                {% endif %}

                <!-- SMART NUMBERS -->
                {% for num in page_numbers %}
                    {% if num > 1 and num < num_pages %}
                        {% if num == current_page_number %}
                            <span class="sb-page-link sb-page-current" data-page="{{ num }}">{{ num }}</span>
                        {% else %}
                            <a href="?page={{ num }}{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                               class="sb-page-link"
                               data-page="{{ num }}">{{ num }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if show_last_ellipsis %}
                    <span class="sb-page-link sb-page-ellipsis">‚Ä¶</span>
                {% endif %}

                {% if num_pages > 1 %}
                    {% if current_page_number == num_pages %}
                        <span class="sb-page-link sb-page-current" data-page="{{ num_pages }}">{{ num_pages }}</span>
                    {% else %}
                        <a href="?page={{ num_pages }}{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                           class="sb-page-link"
                           data-page="{{ num_pages }}">{{ num_pages }}</a>
                    {% endif %}
                {% endif %}

                <!-- NEXT > -->
                {% if current_page_number < num_pages %}
                    <a href="?page={{ current_page_number|add:'1' }}{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                       class="sb-page-link sb-page-next"
                       data-page="{{ current_page_number|add:'1' }}">&rsaquo;</a>
                {% else %}
                    <span class="sb-page-link sb-page-disabled">&rsaquo;</span>
                {% endif %}

                <!-- LAST >> -->
                <a href="?page={{ num_pages }}{% if page_size == 'all' %}&page_size=all{% else %}&page_size={{ page_size }}{% endif %}"
                   class="sb-page-link sb-page-last"
                   data-page="{{ num_pages }}">&raquo;</a>
            </nav>
        {% endif %}
    </div>

    <!-- ===================================== -->
    <!--                TABLE                  -->
    <!-- ===================================== -->

    <div class="sb-table-wrapper">
        <table class="sb-table">
            <thead>
            <tr>
                {# R #}
                {% with col=columns.rack %}
                    <th class="col-rck"
                        style="text-align:center;"
                        title="{{ col.full_label|default:'Rack' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'R' }}
                    </th>
                {% endwith %}

                {# S #}
                {% with col=columns.shelf %}
                    <th class="col-sh"
                        style="text-align:center;"
                        title="{{ col.full_label|default:'Shelf' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'S' }}
                    </th>
                {% endwith %}

                {# B #}
                {% with col=columns.box %}
                    <th class="col-box"
                        style="text-align:center;"
                        title="{{ col.full_label|default:'Box' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'B' }}
                    </th>
                {% endwith %}

                {# GROUP (nigdy nie ukrywamy) #}
                {% with col=columns.group %}
                    <th class="col-group"
                        title="{{ col.full_label|default:'Group' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'Group' }}
                    </th>
                {% endwith %}

                {# NAME #}
                {% with col=columns.name %}
                    <th class="col-name"
                        title="{{ col.full_label|default:'Name' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'Name' }}
                    </th>
                {% endwith %}

                {# DESCRIPTION #}
                {% with col=columns.part_description %}
                    <th class="col-partdesc"
                        title="{{ col.full_label|default:'Part Description' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'Part Description' }}
                    </th>
                {% endwith %}

                {# PART NUMBER #}
                {% with col=columns.part_number %}
                    <th class="col-partnum"
                        title="{{ col.full_label|default:'Part Number' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'Part Number' }}
                    </th>
                {% endwith %}

                {# DCM #}
                {% with col=columns.dcm_number %}
                    <th class="col-dcm"
                        title="{{ col.full_label|default:'DCM Number' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'DCM NUMBER' }}
                    </th>
                {% endwith %}

                {# OEM NAME #}
                {% with col=columns.oem_name %}
                    <th class="col-oemname"
                        title="{{ col.full_label|default:'OEM Name' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'OEM Name' }}
                    </th>
                {% endwith %}

                {# OEM NUMBER #}
                {% with col=columns.oem_number %}
                    <th class="col-oemnum"
                        title="{{ col.full_label|default:'OEM Number' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'OEM Number' }}
                    </th>
                {% endwith %}

                {# VENDOR ‚Äì mo≈ºe byƒá restricted #}
                {% with col=columns.vendor %}
                    {% if is_purchase_admin or 'vendor' not in restricted_fields %}
                        <th class="col-vendor"
                            title="{{ col.full_label|default:'Vendor' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                            {{ col.short_label|default:col.full_label|default:'Vendor' }}
                        </th>
                    {% endif %}
                {% endwith %}

                {# SOURCE LOCATION ‚Äì mo≈ºe byƒá restricted #}
                {% with col=columns.source_location %}
                    {% if is_purchase_admin or 'source_location' not in restricted_fields %}
                        <th class="col-sourceloc"
                            title="{{ col.full_label|default:'Source Location' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                            {{ col.short_label|default:col.full_label|default:'Source Location' }}
                        </th>
                    {% endif %}
                {% endwith %}

                {# UNITS #}
                {% with col=columns.unit %}
                    <th class="col-units"
                        title="{{ col.full_label|default:'Units' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'Units' }}
                    </th>
                {% endwith %}

                {# IN STOCK ‚Äì mo≈ºe byƒá restricted #}
                {% with col=columns.quantity_in_stock %}
                    {% if is_purchase_admin or 'quantity_in_stock' not in restricted_fields %}
                        <th class="col-instock"
                            title="{{ col.full_label|default:'In stock' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                            {{ col.short_label|default:col.full_label|default:'In stock' }}
                        </th>
                    {% endif %}
                {% endwith %}

                {# PRICE ‚Äì mo≈ºe byƒá restricted #}
                {% with col=columns.price %}
                    {% if is_purchase_admin or 'price' not in restricted_fields %}
                        <th class="col-price"
                            title="{{ col.full_label|default:'Price' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                            {{ col.short_label|default:col.full_label|default:'Price' }}
                        </th>
                    {% endif %}
                {% endwith %}

                {# REORDER LEVEL ‚Äì mo≈ºe byƒá restricted #}
                {% with col=columns.reorder_level %}
                    {% if is_purchase_admin or 'reorder_level' not in restricted_fields %}
                        <th class="col-reorderlevel"
                            title="{{ col.full_label|default:'Reorder level' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                            <span>{{ col.short_label|default:col.full_label|default:'Reorder level' }}</span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# RT DAYS #}
                {% with col=columns.reorder_time_days %}
                    <th class="col-rt"
                        title="{{ col.full_label|default:'Reorder Time in Days' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'RT' }}
                    </th>
                {% endwith %}

                {# QTY REORDER ‚Äì mo≈ºe byƒá restricted #}
                {% with col=columns.quantity_in_reorder %}
                    {% if is_purchase_admin or 'quantity_in_reorder' not in restricted_fields %}
                        <th class="col-qtyreorder"
                            title="{{ col.full_label|default:'Quantity Reorder' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                            <span>{{ col.short_label|default:col.full_label|default:'Quantity Reorder' }}</span>
                        </th>
                    {% endif %}
                {% endwith %}

                {# CONDITION #}
                {% with col=columns.condition_status %}
                    <th class="col-condition"
                        title="{{ col.full_label|default:'Condition status' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:col.full_label|default:'Condition' }}
                    </th>
                {% endwith %}

                {# DISC #}
                {% with col=columns.discontinued %}
                    <th class="col-disc"
                        title="{{ col.full_label|default:'Discontinued' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'Disc.' }}
                    </th>
                {% endwith %}

                {# REV #}
                {% with col=columns.verify %}
                    <th class="col-rev"
                        title="{{ col.full_label|default:'To Review / Verify' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'REV.' }}
                    </th>
                {% endwith %}

                {# FAVORITE #}
                {% with col=columns.favorite %}
                    <th class="col-fav"
                        title="{{ col.full_label|default:'Favorite' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'Fav' }}
                    </th>
                {% endwith %}

                {# USER NOTE #}
                {% with col=columns.note %}
                    <th class="col-note"
                        title="{{ col.full_label|default:'User Note' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'Note' }}
                    </th>
                {% endwith %}

                {# REORDER FLAG #}
                {% with col=columns.for_reorder %}
                    <th class="col-reorder"
                        title="{{ col.full_label|default:'Reorder flag' }}{% if col.functional_description %} ‚Äì {{ col.functional_description }}{% endif %}">
                        {{ col.short_label|default:'Reorder' }}
                    </th>
                {% endwith %}
            </tr>
            </thead>

            <tbody>
            {% for item in items %}

                {% with usermeta=item.meta_for_user.0 %}
                    <tr class="sb-row
                               {% if item.verify %} sb-row-verify{% endif %}
                               {% if item.discontinued %} sb-row-disc{% endif %}"
                        data-item-id="{{ item.id }}"
                        data-fav="{{ usermeta.favorite_color|default:'NONE' }}"
                        data-note="{{ usermeta.note|default:''|escape }}">
                {% endwith %}

                    <!-- R/S/B -->
                    <td class="col-rck inline" data-field="rack" data-id="{{ item.id }}">{{ item.rack }}</td>
                    <td class="col-sh inline" data-field="shelf" data-id="{{ item.id }}">{{ item.shelf }}</td>
                    <td class="col-box inline" data-field="box" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.box }}">{{ item.box }}</span>
                    </td>

                    <!-- GROUP -->
                    <td class="col-group">
                        <select class="group-select" data-item-id="{{ item.id }}">
                            {% for g in groups %}
                                <option value="{{ g.id }}" {% if item.group_id == g.id %}selected{% endif %}>
                                    {{ g.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- NAME -->
                    <td class="col-name inline" data-field="name" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.name }}">{{ item.name }}</span>
                    </td>

                    <!-- DESCRIPTION (HTML preview + Quill + inline-ready) -->
                    <td class="col-partdesc"
                        data-id="{{ item.id }}"
                        data-field="part_description">
                        <div class="sb-desc-container">
                            <div class="sb-desc-preview sb-multiline"
                                 title="{{ item.part_description|striptags }}">
                                {{ item.part_description|safe }}
                            </div>
                            <button type="button"
                                    class="sb-desc-edit-btn"
                                    data-id="{{ item.id }}"
                                    title="Open full editor for description">
                                üîç
                            </button>
                        </div>
                    </td>

                    <!-- PART NUMBER -->
                    <td class="col-partnum inline" data-field="part_number" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.part_number }}">{{ item.part_number }}</span>
                    </td>

                    <!-- DCM -->
                    <td class="col-dcm inline" data-field="dcm_number" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.dcm_number }}">{{ item.dcm_number }}</span>
                    </td>

                    <!-- OEM NAME -->
                    <td class="col-oemname inline" data-field="oem_name" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.oem_name }}">{{ item.oem_name }}</span>
                    </td>

                    <!-- OEM NUMBER -->
                    <td class="col-oemnum inline" data-field="oem_number" data-id="{{ item.id }}">
                        <span class="sb-multiline" title="{{ item.oem_number }}">{{ item.oem_number }}</span>
                    </td>

                    <!-- VENDOR -->
                    {% if is_purchase_admin or 'vendor' not in restricted_fields %}
                        <td class="col-vendor inline" data-field="vendor" data-id="{{ item.id }}">
                            <span class="sb-multiline" title="{{ item.vendor }}">{{ item.vendor }}</span>
                        </td>
                    {% endif %}

                    <!-- SOURCE LOCATION -->
                    {% if is_purchase_admin or 'source_location' not in restricted_fields %}
                        <td class="col-sourceloc inline" data-field="source_location" data-id="{{ item.id }}">
                            <span class="sb-multiline" title="{{ item.source_location }}">{{ item.source_location }}</span>
                        </td>
                    {% endif %}

                    <!-- UNITS -->
                    <td class="col-units">
                        <select class="unit-select" data-item-id="{{ item.id }}">
                            {% for u in units %}
                                <option value="{{ u.id }}" {% if item.unit_id == u.id %}selected{% endif %}>
                                    {{ u.code }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- IN STOCK -->
                    {% if is_purchase_admin or 'quantity_in_stock' not in restricted_fields %}
                        <td class="col-instock inline" data-field="quantity_in_stock" data-id="{{ item.id }}">
                            {{ item.quantity_in_stock }}
                        </td>
                    {% endif %}

                    <!-- PRICE -->
                    {% if is_purchase_admin or 'price' not in restricted_fields %}
                        <td class="col-price inline" data-field="price" data-id="{{ item.id }}">
                            {{ item.price }}
                        </td>
                    {% endif %}

                    <!-- REORDER LEVEL -->
                    {% if is_purchase_admin or 'reorder_level' not in restricted_fields %}
                        <td class="col-reorderlevel inline" data-field="reorder_level" data-id="{{ item.id }}">
                            {{ item.reorder_level }}
                        </td>
                    {% endif %}

                    <!-- RT DAYS -->
                    <td class="col-rt inline" data-field="reorder_time_days" data-id="{{ item.id }}">
                        {{ item.reorder_time_days }}
                    </td>

                    <!-- QTY REORDER -->
                    {% if is_purchase_admin or 'quantity_in_reorder' not in restricted_fields %}
                        <td class="col-qtyreorder inline" data-field="quantity_in_reorder" data-id="{{ item.id }}">
                            {{ item.quantity_in_reorder }}
                        </td>
                    {% endif %}

                    <!-- CONDITION DROPDOWN -->
                    <td class="col-condition">
                        <select class="condition-select" data-item-id="{{ item.id }}">
                            <option value="">---</option>
                            {% for value, label in condition_choices %}
                                <option value="{{ value }}" {% if item.condition_status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- DISC CHECKBOX -->
                    <td class="col-disc">
                        <input type="checkbox"
                               class="disc-checkbox"
                               data-item-id="{{ item.id }}"
                               {% if item.discontinued %}checked{% endif %}>
                    </td>

                    <!-- REV CHECKBOX -->
                    <td class="col-rev">
                        <input type="checkbox"
                               class="rev-checkbox"
                               data-item-id="{{ item.id }}"
                               {% if item.verify %}checked{% endif %}>
                    </td>

                    <!-- FAVORITE STAR (per-user) -->
                    {% with fav=item.meta_for_user.0.favorite_color|default:"NONE" %}
                        <td class="col-fav">
                            <span class="sb-favorite"
                                  data-item-id="{{ item.id }}"
                                  data-color="{{ fav }}">
                                {% if fav == "RED" or fav == "GREEN" or fav == "YELLOW" or fav == "BLUE" %}
                                    ‚òÖ
                                {% else %}
                                    ‚òÜ
                                {% endif %}
                            </span>
                        </td>
                    {% endwith %}

                    <!-- USER NOTE BUTTON (per-user) -->
                    {% with note=item.meta_for_user.0.note|default:"" %}
                        <td class="col-note"
                            data-item-id="{{ item.id }}"
                            data-field="note">
                            <button type="button"
                                    class="sb-note-btn{% if note %} sb-note-has-content{% endif %}"
                                    data-item-id="{{ item.id }}"
                                    data-note="{{ note|escape }}"
                                    data-has-note="{% if note %}1{% else %}0{% endif %}"
                                    title="Open full editor for your private note">
                                üìù
                            </button>
                        </td>
                    {% endwith %}

                    <!-- REORDER FLAG -->
                    <td class="col-reorder">
                        {% if item.for_reorder %}
                            <span class="sb-tag sb-tag-warning">YES</span>
                        {% endif %}
                    </td>

                </tr>
            {% empty %}
                <tr>
                    <td colspan="25">No inventory items yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
