{% extends "base.html" %}
{% block title %}Work Log | DesertBrain{% endblock %}

{% block content %}
{{ wl_vehicle_options|json_script:"wl-vehicle-options" }}
{{ wl_state_options|json_script:"wl-state-options" }}
{{ wl_unit_options|json_script:"wl-unit-options" }}
{{ wl_rack_options|json_script:"wl-rack-options" }}
{{ wl_shelf_options|json_script:"wl-shelf-options" }}
<div id="wl-defaults"
     data-default-start="{{ wl_default_start|default:'' }}"
     data-default-end="{{ wl_default_end|default:'' }}"></div>
{{ wl_vehicle_options|json_script:"wl-vehicle-options" }}
{{ wl_state_options|json_script:"wl-state-options" }}
{{ wl_unit_options|json_script:"wl-unit-options" }}

<div class="sb-card">
    <div class="sb-title-row">
        <div class="sb-title-group">
            <h2 class="sb-title">{% if is_master %}Work log master{% else %}Work log list{% endif %}</h2>
            <form class="sb-wl-filters" method="get">
                <label for="wl-filter-due">Due</label>
                <select id="wl-filter-due" name="due_range" onchange="this.form.submit()">
                    {% for opt in due_range_options %}
                        <option value="{{ opt.value }}" {% if opt.value == due_range_selected %}selected{% endif %}>
                            {{ opt.label }}
                        </option>
                    {% endfor %}
                </select>
                <label for="wl-filter-future">Future</label>
                <select id="wl-filter-future" name="future" onchange="this.form.submit()">
                    <option value="show" {% if filter_future == "show" %}selected{% endif %}>Show</option>
                    <option value="hide" {% if filter_future == "hide" %}selected{% endif %}>Hide</option>
                </select>
                <label for="wl-filter-loc">Location</label>
                <select id="wl-filter-loc" name="loc" onchange="this.form.submit()">
                    <option value="">-----</option>
                    {% for loc in wl_vehicle_options %}
                        <option value="{{ loc.id }}" {% if filter_loc|stringformat:"s" == loc.id|stringformat:"s" %}selected{% endif %}>
                            {{ loc.name }}
                        </option>
                    {% endfor %}
                </select>
                <label for="wl-filter-state">State</label>
                <select id="wl-filter-state" name="state" onchange="this.form.submit()">
                    <option value="">-----</option>
                    {% for st in wl_state_options %}
                        <option value="{{ st.id }}" {% if filter_state|stringformat:"s" == st.id|stringformat:"s" %}selected{% endif %}>
                            {{ st.short_name }}
                        </option>
                    {% endfor %}
                </select>
                {% if is_master %}
                    <label for="wl-filter-user">User</label>
                    <select id="wl-filter-user" name="user" onchange="this.form.submit()">
                        <option value="">-----</option>
                        {% for usr in wl_user_options %}
                            <option value="{{ usr.author_id }}" {% if filter_user|stringformat:"s" == usr.author_id|stringformat:"s" %}selected{% endif %}>
                                {{ usr.author__username }}
                            </option>
                        {% endfor %}
                    </select>
                {% endif %}
                <noscript><button type="submit" class="sb-btn sb-btn-secondary">Apply</button></noscript>
            </form>
        </div>
        {% if not hide_add %}
            <button type="button" id="sb-wl-add-btn" class="sb-add-item-btn">
                <span class="sb-search-icon sb-plus-icon">+</span>
                <span>work log</span>
            </button>
        {% endif %}
    </div>
    <div class="sb-table-wrapper">
        <table class="sb-table sb-wl-table">
            <thead>
            <tr>
                {% if is_master %}
                    <th class="wl-col-user">User</th>
                {% endif %}
                <th class="wl-col-number">WL #</th>
                <th>Locations</th>
                <th>State</th>
                <th class="wl-col-note">Note</th>
                <th class="wl-col-created">Created</th>
                <th class="wl-col-updated">Last edited</th>
                <th class="wl-col-edit">
                    {% if is_master %}
                        View / Send / Download
                    {% else %}
                        View / Edit / Send / Download
                    {% endif %}
                </th>
                {% if request.user.username == "leo-admin" %}
                    <th class="wl-col-delete">Delete</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% if worklogs %}
                {% for wl in worklogs %}
                    <tr>
                        {% if is_master %}
                            <td>{{ wl.author }}</td>
                        {% endif %}
                        <td>
                            <a href="#"
                               class="sb-link wl-link"
                               data-wl-id="{{ wl.number }}"
                               data-wl-pk="{{ wl.id }}">
                               {{ wl.number }}
                            </a>
                        </td>
                        <td>{{ wl.locations }}</td>
                        <td>{{ wl.states }}</td>
                        <td class="wl-note-cell">{{ wl.note }}</td>
                        <td>{{ wl.created|date:"Y-m-d H:i" }}</td>
                        <td>{{ wl.updated|date:"Y-m-d H:i" }}</td>
                        <td class="wl-actions">
                            {% if is_master %}
                                <button class="sb-btn sb-btn-primary wl-view-btn"
                                        type="button"
                                        title="View"
                                        data-wl-pk="{{ wl.id }}"
                                        data-wl-id="{{ wl.number }}">
                                    <span class="sb-search-icon wl-view-icon">üîç</span>
                                </button>
                            {% else %}
                                {% if wl.can_edit %}
                                    <button class="sb-btn sb-btn-primary wl-edit-btn"
                                            type="button"
                                            title="{{ wl.edit_hint }}"
                                            data-wl-pk="{{ wl.id }}">
                                        <svg class="sb-icon-pencil" viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M12 20H21" />
                                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" />
                                        </svg>
                                    </button>
                                {% else %}
                                    <button class="sb-btn sb-btn-primary wl-view-btn"
                                            type="button"
                                            title="{{ wl.edit_hint }}"
                                            data-wl-pk="{{ wl.id }}"
                                            data-wl-id="{{ wl.number }}">
                                        <span class="sb-search-icon wl-view-icon">üîç</span>
                                    </button>
                                {% endif %}
                            {% endif %}
                            {% if wl.email_sent_at %}
                                <span class="wl-status-icon wl-delivered" title="Delivered {{ wl.email_sent_at|date:'Y-m-d H:i' }}">
                                    ‚úî‚úâÔ∏è
                                </span>
                            {% else %}
                                <button class="wl-send-now-btn"
                                        type="button"
                                        data-wl-pk="{{ wl.id }}"
                                        data-is-pending="1"
                                        data-default-icon="{% if wl.email_pending %}üïí{% else %}?{% endif %}"
                                        data-hover-icon="‚ñ∂Ô∏è"
                                        title="{% if wl.email_pending %}This work log is scheduled to send at {{ wl.email_scheduled_at|date:'H:i'|default:wl_default_end|default:'end time' }}&#10;Click to send now{% else %}Click to send now{% endif %}">
                                    <span class="wl-send-now-icon">{% if wl.email_pending %}üïí{% else %}?{% endif %}</span>
                                </button>
                            {% endif %}
                            <a class="sb-btn sb-btn-secondary wl-download-btn"
                               title="Download DOCX"
                               href="{% url 'download_work_log_docx' wl.id %}">
                                ‚¨á
                            </a>
                        </td>
                        {% if request.user.username == "leo-admin" %}
                            <td class="wl-delete-cell">
                                <button class="sb-btn sb-btn-secondary wl-delete-btn"
                                        type="button"
                                        data-wl-pk="{{ wl.id }}"
                                        data-wl-num="{{ wl.number }}"
                                        title="Delete work log">
                                    ‚úï
                                </button>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{% if is_master %}{% if request.user.username == 'leo-admin' %}9{% else %}8{% endif %}{% else %}{% if request.user.username == 'leo-admin' %}8{% else %}7{% endif %}{% endif %}" class="wl-empty-row">No work logs yet.</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div id="wl-modal" class="sb-modal">
    <div class="sb-modal-dialog">
        <div class="sb-modal-header">
            <h2 class="sb-modal-title" id="wl-modal-title">Work Log</h2>
            <button type="button" class="sb-modal-close" id="wl-modal-close">‚úï</button>
        </div>
        <div class="sb-modal-body" id="wl-modal-body">
            <div class="sb-wl-header-grid">
                <div class="sb-wl-divider"></div>
                <div class="sb-wl-header-row">
                    <span>Author</span>
                    <span id="wl-author"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Due date</span>
                    <span id="wl-due"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Created</span>
                    <span id="wl-created"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Last edited</span>
                    <span id="wl-updated"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Start - End</span>
                    <span id="wl-time"></span>
                </div>
            </div>
            <div class="sb-wl-section">
                <strong>Entries:</strong>
                <div class="sb-table-wrapper">
                    <table class="sb-table sb-wl-entries-table">
                        <thead>
                        <tr>
                            <th class="wl-veh">Vehicle <span class="sb-required-asterisk">*</span></th>
                            <th class="wl-job">Job description <span class="sb-required-asterisk">*</span></th>
                            <th>State <span class="sb-required-asterisk">*</span></th>
                            <th class="col-time">Time <span class="sb-required-asterisk">*</span></th>
                            <th class="wl-rack">Rack</th>
                            <th class="wl-shelf">Shelf</th>
                            <th class="wl-box">Box</th>
                            <th>Part description</th>
                            <th>Unit</th>
                            <th>Qty</th>
                            <th class="wl-notes-col">Notes</th>
                        </tr>
                        </thead>
                        <tbody id="wl-entries-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="sb-add-field sb-wl-notes is-hidden" id="wl-notes-wrap">
                <label>Notes</label>
                <textarea id="wl-notes" rows="4" disabled></textarea>
            </div>
        </div>
        <div class="sb-modal-footer">
            <button type="button" class="sb-btn sb-btn-secondary" id="wl-modal-close-2">Close</button>
        </div>
    </div>
</div>

<div id="wl-add-modal" class="sb-modal">
    <div class="sb-modal-dialog">
        <div class="sb-modal-header">
            <h2 class="sb-modal-title">Add Work Log</h2>
            <button type="button" class="sb-modal-close" id="wl-add-close">‚úï</button>
        </div>
        <form id="wl-add-form">
            <div class="sb-modal-body">
                <div class="sb-inline-fields">
                    <div class="sb-add-field">
                        <label for="wl-add-due">Due date</label>
                        <input type="text"
                               id="wl-add-due"
                               name="due_date"
                               placeholder="YYYY-MM-DD"
                               pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}"
                               inputmode="numeric"
                               title="Use format YYYY-MM-DD"
                               required>
                    </div>
                    <div class="sb-add-field">
                        <label for="wl-add-start">Start time</label>
                        <input type="time" id="wl-add-start" name="start_time">
                    </div>
                    <div class="sb-add-field">
                        <label for="wl-add-end">End time</label>
                        <input type="time" id="wl-add-end" name="end_time">
                    </div>
                </div>
                <div class="sb-wl-section">
                    <strong>Entries</strong>
                    <div class="sb-table-wrapper">
                        <table class="sb-table sb-wl-entries-table" id="wl-add-entries-table">
                            <thead>
                            <tr>
                                <th class="wl-veh">Vehicle <span class="sb-required-asterisk">*</span></th>
                                <th class="wl-job">Job description <span class="sb-required-asterisk">*</span></th>
                                <th>State <span class="sb-required-asterisk">*</span></th>
                                <th class="col-time">Time <span class="sb-required-asterisk">*</span></th>
                                <th class="wl-rack">Rack</th>
                                <th class="wl-shelf">Shelf</th>
                                <th class="wl-box">Box</th>
                                <th>Part description</th>
                                <th>Unit</th>
                                <th>Qty</th>
                                <th class="wl-notes-col">Notes</th>
                                <th class="wl-col-edit">Del</th>
                            </tr>
                            </thead>
                            <tbody id="wl-add-entries-body"></tbody>
                        </table>
                    </div>
                    <button type="button" class="sb-btn sb-btn-secondary" id="wl-add-entry-btn">Add entry</button>
                </div>
                <div class="sb-add-field sb-wl-notes">
                    <label for="wl-add-notes">Notes</label>
                    <textarea id="wl-add-notes" name="notes" rows="3" placeholder="Optional"></textarea>
                </div>
            </div>
            <div class="sb-modal-footer">
                <button type="button" class="sb-btn sb-btn-secondary" id="wl-add-cancel">Cancel</button>
                {% if wl_allow_schedule %}
                    <button type="button" class="sb-btn sb-btn-secondary" id="wl-add-save-later">
                        Save and send at {{ wl_default_end|default:"end time" }}
                    </button>
                {% endif %}
                <button type="submit" class="sb-btn sb-btn-primary" id="wl-add-save">Save &amp; email</button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
    }
    function getCsrfToken() {
        return getCookie("csrftoken") || "";
    }

    const modal = document.getElementById("wl-modal");
    const closeButtons = [document.getElementById("wl-modal-close"), document.getElementById("wl-modal-close-2")];
    function hideModal() { modal.style.display = "none"; }
    closeButtons.forEach(btn => { if (btn) btn.addEventListener("click", hideModal); });
    modal.addEventListener("click", function(e) {
        if (e.target === modal) hideModal();
    });

    function fillModal(data) {
        const wl = data.worklog || {};
        document.getElementById("wl-modal-title").textContent = wl.number || "Work Log";
        document.getElementById("wl-author").textContent = wl.user_full || wl.author || "";
        document.getElementById("wl-due").textContent = wl.due_date || "";
        document.getElementById("wl-created").textContent = wl.created_at || "";
        document.getElementById("wl-updated").textContent = wl.updated_at || "";
        let st = wl.start_time || "";
        let et = wl.end_time || "";
        document.getElementById("wl-time").textContent = (st || et) ? (st + " - " + et) : "";
        const notesWrap = document.getElementById("wl-notes-wrap");
        const notesField = document.getElementById("wl-notes");
        notesField.value = wl.notes || "";
        notesWrap.classList.toggle("is-hidden", !wl.notes);
        const entriesBody = document.getElementById("wl-entries-body");
        entriesBody.innerHTML = "";
        const entries = wl.entries || [];
        const frag = document.createDocumentFragment();
        if (!entries.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 11;
            td.className = "wl-empty-row";
            td.textContent = "No entries.";
            tr.appendChild(td);
            frag.appendChild(tr);
        } else {
            entries.forEach((en) => {
                const tr = document.createElement("tr");
                const cells = [
                    {val: en.vehicle || ""},
                    {val: en.job_description || "", cls: "wl-job"},
                    {val: en.state || ""},
                    {val: en.time_hours || "", cls: "col-time"},
                    {val: en.inventory_rack ?? "", cls: "wl-rack"},
                    {val: en.inventory_shelf || "", cls: "wl-shelf"},
                    {val: en.inventory_box || "", cls: "wl-box"},
                    {val: en.part_description || ""},
                    {val: en.unit || ""},
                    {val: en.quantity || ""},
                    {val: en.notes || ""},
                ];
                cells.forEach((cell) => {
                    const td = document.createElement("td");
                    if (cell.cls) td.className = cell.cls;
                    td.textContent = cell.val;
                    tr.appendChild(td);
                });
                frag.appendChild(tr);
            });
        }
        entriesBody.appendChild(frag);
        modal.style.display = "flex";
    }

    function onLinkClick(e) {
        e.preventDefault();
        const pk = this.getAttribute("data-wl-pk");
        const num = this.getAttribute("data-wl-id");
        if (!pk) return;
        fetch(`/api/work-log/${pk}/`)
            .then(r => r.json())
            .then(data => {
                if (!data.ok) throw new Error("Load failed");
                // format dates nicely
                ["created_at","updated_at"].forEach(k => {
                    if (data.worklog && data.worklog[k]) {
                        data.worklog[k] = new Date(data.worklog[k]).toLocaleString();
                    }
                });
                if (data.worklog && data.worklog.due_date) {
                    data.worklog.due_date = data.worklog.due_date;
                }
                fillModal(data);
            })
            .catch(err => {
                alert("Failed to load work log " + num + ": " + err);
            });
    }

    document.querySelectorAll(".wl-link").forEach((a) => {
        a.addEventListener("click", onLinkClick);
    });
    document.querySelectorAll(".wl-view-btn").forEach((btn) => {
        btn.addEventListener("click", function() {
            const pk = this.getAttribute("data-wl-pk");
            const num = this.getAttribute("data-wl-id");
            if (!pk) return;
            fetch(`/api/work-log/${pk}/`)
                .then(r => r.json())
                .then(data => {
                    if (!data.ok) throw new Error("Load failed");
                    // format dates
                    ["created_at","updated_at"].forEach(k => {
                        if (data.worklog && data.worklog[k]) {
                            data.worklog[k] = new Date(data.worklog[k]).toLocaleString();
                        }
                    });
                    fillModal(data);
                })
                .catch(err => alert("Failed to load work log " + (num || "") + ": " + err));
        });
    });
    document.querySelectorAll(".wl-edit-btn").forEach((btn) => {
        btn.addEventListener("click", function() {
            const pk = this.getAttribute("data-wl-pk");
            if (!pk) return;
            fetch(`/api/work-log/${pk}/`)
                .then(r => r.json())
                .then(data => {
                    if (!data.ok) throw new Error("Load failed");
                    showAddModal("edit", data);
                })
                .catch(err => alert("Failed to load work log: " + err));
        });
    });

    // Add modal form
    const addModal = document.getElementById("wl-add-modal");
    const addBtn = document.getElementById("sb-wl-add-btn");
    const addInlineBtn = document.getElementById("sb-wl-add-inline");
    const addClose = document.getElementById("wl-add-close");
    const addCancel = document.getElementById("wl-add-cancel");
    const addForm = document.getElementById("wl-add-form");
    let submitMode = "email_now";
    const modeInput = document.createElement("input");
    modeInput.type = "hidden";
    modeInput.name = "mode";
    modeInput.value = "create";
    const wlIdInput = document.createElement("input");
    wlIdInput.type = "hidden";
    wlIdInput.name = "wl_id";
    addForm.appendChild(modeInput);
    addForm.appendChild(wlIdInput);

    const addEntryBtn = document.getElementById("wl-add-entry-btn");
    const saveLaterBtn = document.getElementById("wl-add-save-later");
    const entriesBodyAdd = document.getElementById("wl-add-entries-body");
    const vehicleOptions = JSON.parse(document.getElementById("wl-vehicle-options").textContent);
    const stateOptions = JSON.parse(document.getElementById("wl-state-options").textContent);
    const unitOptions = JSON.parse(document.getElementById("wl-unit-options").textContent);
    const rackOptions = JSON.parse(document.getElementById("wl-rack-options").textContent);
    const shelfOptions = JSON.parse(document.getElementById("wl-shelf-options").textContent);
    const defaultsHolder = document.getElementById("wl-defaults");

    function toggleScheduleButton() {
        if (!saveLaterBtn) return;
        const startStr = defaultsHolder?.dataset.defaultStart || "";
        const endStr = defaultsHolder?.dataset.defaultEnd || "";
        if (!startStr || !endStr) {
            saveLaterBtn.style.display = "none";
            return;
        }
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);
        const start = new Date(`${todayStr}T${startStr}`);
        const endRaw = new Date(`${todayStr}T${endStr}`);
        const endMinus = new Date(endRaw.getTime() - 5 * 60 * 1000);
        if (now >= start && now <= endMinus) {
            saveLaterBtn.style.display = "";
        } else {
            saveLaterBtn.style.display = "none";
        }
    }

    function hideAddModal() {
        addModal.style.display = "none";
    }
    function resetAddForm(clearValues=true) {
        if (!addForm) return;
        if (clearValues) addForm.reset();
        entriesBodyAdd.innerHTML = "";
    }
    function showAddModal(mode="create", data=null) {
        addModal.style.display = "flex";
        resetAddForm(false);
        modeInput.value = mode;
        wlIdInput.value = mode === "edit" && data?.worklog ? data.worklog.id || "" : "";
        const titleEl = document.querySelector("#wl-add-modal .sb-modal-title");
        if (titleEl) titleEl.textContent = mode === "edit" ? "Edit Work Log" : "Add Work Log";

        const dueInput = document.getElementById("wl-add-due");
        const startInput = document.getElementById("wl-add-start");
        const endInput = document.getElementById("wl-add-end");
        const notesInput = document.getElementById("wl-add-notes");

        if (mode === "edit" && data?.worklog) {
            const wl = data.worklog;
            if (dueInput) dueInput.value = wl.due_date || "";
            if (startInput) startInput.value = wl.start_time || "";
            if (endInput) endInput.value = wl.end_time || "";
            if (notesInput) notesInput.value = wl.notes || "";
            entriesBodyAdd.innerHTML = "";
            const entries = wl.entries || [];
            if (entries.length) {
                entries.forEach(en => addEntryRow(en));
            } else {
                addEntryRow();
            }
        } else {
            // defaults for create
            const today = new Date();
            const todayStr = today.toISOString().slice(0,10); // YYYY-MM-DD
            if (dueInput) dueInput.value = todayStr;
            if (startInput) startInput.value = defaultsHolder.dataset.defaultStart || "";
            if (endInput) endInput.value = defaultsHolder.dataset.defaultEnd || "";
            if (notesInput) notesInput.value = "";
            if (!entriesBodyAdd.children.length) addEntryRow();
        }
        toggleScheduleButton();
    }

    // Custom validation messages (force English)
    const dueFormatInput = document.getElementById("wl-add-due");
    if (dueFormatInput) {
        dueFormatInput.addEventListener("invalid", (e) => {
            e.target.setCustomValidity("Please use format YYYY-MM-DD");
        });
        dueFormatInput.addEventListener("input", (e) => {
            e.target.setCustomValidity("");
        });
        dueFormatInput.addEventListener("change", (e) => {
            e.target.setCustomValidity("");
        });
    }
    // Helper to attach English validation messages
    function attachValidation(el) {
        if (!el) return;
        el.addEventListener("invalid", (e) => {
            const fieldType = el.type || el.tagName.toLowerCase();
            if (el === dueFormatInput) return; // handled above
            if (el.required && !el.value) {
                e.target.setCustomValidity("This field is required.");
            } else if (fieldType === "number") {
                e.target.setCustomValidity("Please enter a valid number.");
            } else if (fieldType === "time") {
                e.target.setCustomValidity("Please enter a valid time.");
            } else {
                e.target.setCustomValidity("");
            }
        });
        el.addEventListener("input", (e) => e.target.setCustomValidity(""));
        el.addEventListener("change", (e) => e.target.setCustomValidity(""));
    }

    if (addForm) {
        const inputs = addForm.querySelectorAll("input, select, textarea");
        inputs.forEach(attachValidation);
    }

    function buildSelect(options, placeholder) {
        const sel = document.createElement("select");
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        sel.appendChild(opt);
        options.forEach((o) => {
            const optEl = document.createElement("option");
            const optionValue = (o.value !== undefined && o.value !== null)
                ? o.value
                : (o.id !== undefined && o.id !== null)
                    ? o.id
                    : (o.code !== undefined ? o.code : o.short_name);
            const optionLabel = o.label || o.name || o.short_name || o.code || optionValue || "";
            optEl.value = optionValue != null ? optionValue.toString() : "";
            optEl.textContent = optionLabel;
            sel.appendChild(optEl);
        });
        return sel;
    }

    function addEntryRow(prefill=null) {
        const tr = document.createElement("tr");

        // Vehicle
        const tdVeh = document.createElement("td");
        const selVeh = buildSelect(vehicleOptions, "Select");
        selVeh.name = "entry_vehicle[]";
        selVeh.required = true;
        attachValidation(selVeh);
        if (prefill && prefill.vehicle_id) selVeh.value = prefill.vehicle_id;
        tdVeh.appendChild(selVeh);
        tr.appendChild(tdVeh);

        // Job description
        const tdJob = document.createElement("td");
        const jobInput = document.createElement("textarea");
        jobInput.name = "entry_job[]";
        jobInput.rows = 2;
        jobInput.required = true;
        attachValidation(jobInput);
        if (prefill && prefill.job_description) jobInput.value = prefill.job_description;
        tdJob.appendChild(jobInput);
        tr.appendChild(tdJob);

        // State
        const tdState = document.createElement("td");
        const selState = buildSelect(stateOptions, "Select");
        selState.name = "entry_state[]";
        selState.required = true;
        attachValidation(selState);
        if (prefill && prefill.state_id) selState.value = prefill.state_id;
        tdState.appendChild(selState);
        tr.appendChild(tdState);

        // Time
        const tdTime = document.createElement("td");
        const timeInput = document.createElement("input");
        timeInput.type = "number";
        timeInput.step = "0.25";
        timeInput.min = "0";
        timeInput.name = "entry_time[]";
        timeInput.required = true;
        attachValidation(timeInput);
        if (prefill && prefill.time_hours !== undefined && prefill.time_hours !== null) {
            timeInput.value = prefill.time_hours;
        }
        tdTime.className = "col-time";
        tdTime.appendChild(timeInput);
        tr.appendChild(tdTime);

        // Rack
        const tdRack = document.createElement("td");
        tdRack.className = "wl-rack";
        const rackSel = buildSelect(rackOptions, "Rack");
        rackSel.name = "entry_rack[]";
        rackSel.required = true;
        attachValidation(rackSel);
        if (prefill && prefill.inventory_rack !== undefined && prefill.inventory_rack !== null) {
            rackSel.value = String(prefill.inventory_rack);
        }
        tdRack.appendChild(rackSel);
        tr.appendChild(tdRack);

        // Shelf
        const tdShelf = document.createElement("td");
        tdShelf.className = "wl-shelf";
        const shelfSel = buildSelect(shelfOptions, "Shelf");
        shelfSel.name = "entry_shelf[]";
        shelfSel.required = true;
        attachValidation(shelfSel);
        if (prefill && prefill.inventory_shelf) {
            shelfSel.value = prefill.inventory_shelf;
        }
        tdShelf.appendChild(shelfSel);
        tr.appendChild(tdShelf);

        // Box
        const tdBox = document.createElement("td");
        tdBox.className = "wl-box";
        const boxInput = document.createElement("input");
        boxInput.type = "text";
        boxInput.name = "entry_box[]";
        boxInput.placeholder = "Box";
        boxInput.required = true;
        attachValidation(boxInput);
        if (prefill && prefill.inventory_box) {
            boxInput.value = prefill.inventory_box;
        }
        tdBox.appendChild(boxInput);
        tr.appendChild(tdBox);

        // Part description
        const tdPartDesc = document.createElement("td");
        const partDescInput = document.createElement("input");
        partDescInput.type = "text";
        partDescInput.name = "entry_part_desc[]";
        attachValidation(partDescInput);
        if (prefill && prefill.part_description) partDescInput.value = prefill.part_description;
        tdPartDesc.appendChild(partDescInput);
        tr.appendChild(tdPartDesc);

        // Unit
        const tdUnit = document.createElement("td");
        const unitSel = buildSelect(unitOptions, "Unit");
        unitSel.name = "entry_unit[]";
        attachValidation(unitSel);
        if (prefill && prefill.unit_id) unitSel.value = prefill.unit_id;
        tdUnit.appendChild(unitSel);
        tr.appendChild(tdUnit);

        // Qty
        const tdQty = document.createElement("td");
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.step = "0.01";
        qtyInput.min = "0";
        qtyInput.name = "entry_qty[]";
        attachValidation(qtyInput);
        if (prefill && prefill.quantity !== undefined && prefill.quantity !== null) {
            qtyInput.value = prefill.quantity;
        }
        tdQty.appendChild(qtyInput);
        tr.appendChild(tdQty);

        // Notes
        const tdNotes = document.createElement("td");
        const notesInput = document.createElement("textarea");
        notesInput.name = "entry_notes[]";
        notesInput.rows = 2;
        if (prefill && prefill.notes) notesInput.value = prefill.notes;
        tdNotes.appendChild(notesInput);
        tr.appendChild(tdNotes);

        // Delete
        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "sb-btn sb-btn-secondary";
        delBtn.textContent = "‚úï";
        delBtn.addEventListener("click", () => tr.remove());
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        entriesBodyAdd.appendChild(tr);
    }

    [addClose, addCancel].forEach((btn) => {
        if (btn) btn.addEventListener("click", hideAddModal);
    });
    if (addEntryBtn) addEntryBtn.addEventListener("click", addEntryRow);
    if (saveLaterBtn) {
        saveLaterBtn.addEventListener("click", () => {
            submitMode = "schedule";
            addForm.requestSubmit();
        });
    }
    if (addForm) {
        addForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const fd = new FormData(addForm);
            const mode = modeInput.value === "edit" ? "edit" : "create";
            const wlId = wlIdInput.value;
            const url = mode === "edit" && wlId
                ? `/api/work-log/${wlId}/update/`
                : "/api/work-log/create/";
            fd.append("send_mode", submitMode || "email_now");
            fetch(url, {
                method: "POST",
                headers: { "X-CSRFToken": getCsrfToken() },
                body: fd,
            })
                .then(async (r) => {
                    if (!r.ok) {
                        const text = await r.text();
                        throw new Error(`HTTP ${r.status}: ${text.slice(0, 200)}`);
                    }
                    return r.json();
                })
                .then(data => {
                    submitMode = "email_now";
                    if (!data.ok) {
                        throw new Error(data.error || "Save failed");
                    }
                    hideAddModal();
                    if (data.scheduled_at) {
                        alert(`Work log ${data.number} scheduled to send at ${data.scheduled_at}`);
                    } else if (data.email_recipient) {
                        alert(`Work log ${data.number} sent to ${data.email_recipient}`);
                    }
                    // After create, reset filters so the new item is visible.
                    if (mode === "create") {
                        window.location.href = "/work-log/?due_range=last_90";
                    } else {
                        window.location.reload();
                    }
                })
                .catch(err => {
                    submitMode = "email_now";
                    alert("Save work log failed: " + err.message);
                });
        });
    }
    if (addBtn) {
        addBtn.addEventListener("click", () => showAddModal("create", null));
    }
    if (addInlineBtn) {
        addInlineBtn.addEventListener("click", (e) => {
            // allow use from other pages via href, but when on WL page open modal without reload
            e.preventDefault();
            showAddModal("create", null);
        }, false);
        // autofocus when coming from ?add=1
        const params = new URLSearchParams(window.location.search);
        if (params.get("add") === "1") {
            showAddModal("create", null);
            // remove param from URL
            const url = new URL(window.location);
            url.searchParams.delete("add");
            window.history.replaceState({}, "", url);
        }
    }
    // Clicking outside should not close the modal.

    // Delete (leo-admin only)
    document.querySelectorAll(".wl-delete-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const pk = this.dataset.wlPk;
            const num = this.dataset.wlNum || "";
            if (!pk) return;
            if (!confirm(`Delete work log ${num || pk}?`)) return;
            fetch(`/api/work-log/${pk}/delete/`, {
                method: "POST",
                headers: { "X-CSRFToken": getCsrfToken() },
            })
                .then(async (r) => {
                    if (!r.ok) {
                        const text = await r.text();
                        throw new Error(`HTTP ${r.status}: ${text.slice(0, 200)}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data.ok) throw new Error(data.error || "Delete failed");
                    alert(`Work log ${num || pk} deleted.`);
                    window.location.reload();
                })
                .catch(err => alert("Delete failed: " + err.message));
        });
    });

    // Send now (for scheduled emails)
    document.querySelectorAll(".wl-send-now-btn").forEach(btn => {
        const iconEl = btn.querySelector(".wl-send-now-icon");
        const defIcon = btn.dataset.defaultIcon || (btn.dataset.isPending === "1" ? "üïí" : "?");
        const hoverIcon = btn.dataset.hoverIcon || "‚ñ∂Ô∏è";
        if (iconEl) iconEl.textContent = defIcon;
        btn.addEventListener("mouseenter", () => {
            if (iconEl) iconEl.textContent = hoverIcon;
        });
        btn.addEventListener("mouseleave", () => {
            if (iconEl) iconEl.textContent = defIcon;
        });
        btn.addEventListener("click", () => {
            const pk = btn.dataset.wlPk;
            if (!pk) return;
            fetch(`/api/work-log/${pk}/send-now/`, {
                method: "POST",
                headers: { "X-CSRFToken": getCsrfToken() },
            })
                .then(async (r) => {
                    if (!r.ok) {
                        const t = await r.text();
                        throw new Error(`HTTP ${r.status}: ${t.slice(0, 200)}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data.ok) throw new Error(data.error || "Send failed");
                    if (iconEl) iconEl.textContent = "‚úî‚úâÔ∏è";
                    btn.classList.add("wl-sent");
                    btn.disabled = true;
                    alert(`Work log ${data.number || pk} sent now.`);
                })
                .catch(err => alert("Send now failed: " + err.message));
        });
    });
})();
</script>
{% endblock %}
