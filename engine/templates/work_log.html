{% extends "base.html" %}
{% block title %}Work Log | DesertBrain{% endblock %}

{% block content %}
<div class="sb-card">
    <h2 class="sb-title">Work log list</h2>
    <div class="sb-table-wrapper">
        <table class="sb-table sb-wl-table">
            <thead>
            <tr>
                <th class="wl-col-number">WL #</th>
                <th>Locations</th>
                <th class="wl-col-created">Created</th>
                <th class="wl-col-updated">Last edited</th>
                <th class="wl-col-edit">Edit</th>
            </tr>
            </thead>
            <tbody>
            {% if worklogs %}
                {% for wl in worklogs %}
                    <tr>
                        <td>
                            <a href="#"
                               class="sb-link wl-link"
                               data-wl-id="{{ wl.number }}"
                               data-wl-pk="{{ wl.id }}">
                                {{ wl.number }}
                            </a>
                        </td>
                        <td>{{ wl.locations }}</td>
                        <td>{{ wl.created|date:"Y-m-d H:i" }}</td>
                        <td>{{ wl.updated|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if wl.can_edit %}
                                <button class="sb-btn sb-btn-primary" type="button" title="Edit">
                                    <svg class="sb-icon-pencil" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M12 20H21" />
                                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" />
                                    </svg>
                                </button>
                            {% else %}
                                <button class="sb-btn sb-btn-secondary" type="button" disabled>Locked</button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="wl-empty-row">No work logs yet.</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div id="wl-modal" class="sb-modal">
    <div class="sb-modal-dialog">
        <div class="sb-modal-header">
            <h2 class="sb-modal-title" id="wl-modal-title">Work Log</h2>
            <button type="button" class="sb-modal-close" id="wl-modal-close">âœ•</button>
        </div>
        <div class="sb-modal-body" id="wl-modal-body">
            <div class="sb-wl-header-grid">
                <div class="sb-wl-divider"></div>
                <div class="sb-wl-header-row">
                    <span>Author</span>
                    <span id="wl-author"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Due date</span>
                    <span id="wl-due"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Created</span>
                    <span id="wl-created"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Last edited</span>
                    <span id="wl-updated"></span>
                </div>
                <div class="sb-wl-header-row">
                    <span>Start - End</span>
                    <span id="wl-time"></span>
                </div>
            </div>
            <div class="sb-wl-section">
                <strong>Entries:</strong>
                <div class="sb-table-wrapper">
                    <table class="sb-table sb-wl-entries-table">
                        <thead>
                        <tr>
                            <th class="wl-veh">Vehicle</th>
                            <th class="wl-job">Job description</th>
                            <th class="wl-part">Part Utilize</th>
                            <th class="col-time">Time</th>
                            <th class="wl-notes-col">Notes</th>
                        </tr>
                        </thead>
                        <tbody id="wl-entries-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="sb-add-field sb-wl-notes is-hidden" id="wl-notes-wrap">
                <label>Notes</label>
                <textarea id="wl-notes" rows="4" disabled></textarea>
            </div>
        </div>
        <div class="sb-modal-footer">
            <button type="button" class="sb-btn sb-btn-secondary" id="wl-modal-close-2">Close</button>
        </div>
    </div>
</div>

<script>
(function() {
    const modal = document.getElementById("wl-modal");
    const closeButtons = [document.getElementById("wl-modal-close"), document.getElementById("wl-modal-close-2")];
    function hideModal() { modal.style.display = "none"; }
    closeButtons.forEach(btn => { if (btn) btn.addEventListener("click", hideModal); });
    modal.addEventListener("click", function(e) {
        if (e.target === modal) hideModal();
    });

    function fillModal(data) {
        const wl = data.worklog || {};
        document.getElementById("wl-modal-title").textContent = wl.number || "Work Log";
        document.getElementById("wl-author").textContent = wl.user_full || wl.author || "";
        document.getElementById("wl-due").textContent = wl.due_date || "";
        document.getElementById("wl-created").textContent = wl.created_at || "";
        document.getElementById("wl-updated").textContent = wl.updated_at || "";
        let st = wl.start_time || "";
        let et = wl.end_time || "";
        document.getElementById("wl-time").textContent = (st || et) ? (st + " - " + et) : "";
        const notesWrap = document.getElementById("wl-notes-wrap");
        const notesField = document.getElementById("wl-notes");
        notesField.value = wl.notes || "";
        notesWrap.classList.toggle("is-hidden", !wl.notes);
        const entriesBody = document.getElementById("wl-entries-body");
        entriesBody.innerHTML = "";
        const entries = wl.entries || [];
        const frag = document.createDocumentFragment();
        if (!entries.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 5;
            td.className = "wl-empty-row";
            td.textContent = "No entries.";
            tr.appendChild(td);
            frag.appendChild(tr);
        } else {
            entries.forEach((en) => {
                const tr = document.createElement("tr");
                const cells = [
                    {val: en.vehicle || ""},
                    {val: en.job_description || ""},
                    {val: en.part_description || ""},
                    {val: en.time_hours || "", cls: "col-time"},
                    {val: en.notes || ""},
                ];
                cells.forEach((cell) => {
                    const td = document.createElement("td");
                    if (cell.cls) td.className = cell.cls;
                    td.textContent = cell.val;
                    tr.appendChild(td);
                });
                frag.appendChild(tr);
            });
        }
        entriesBody.appendChild(frag);
        modal.style.display = "flex";
    }

    function onLinkClick(e) {
        e.preventDefault();
        const pk = this.getAttribute("data-wl-pk");
        const num = this.getAttribute("data-wl-id");
        if (!pk) return;
        fetch(`/api/work-log/${pk}/`)
            .then(r => r.json())
            .then(data => {
                if (!data.ok) throw new Error("Load failed");
                // format dates nicely
                ["created_at","updated_at"].forEach(k => {
                    if (data.worklog && data.worklog[k]) {
                        data.worklog[k] = new Date(data.worklog[k]).toLocaleString();
                    }
                });
                if (data.worklog && data.worklog.due_date) {
                    data.worklog.due_date = data.worklog.due_date;
                }
                fillModal(data);
            })
            .catch(err => {
                alert("Failed to load work log " + num + ": " + err);
            });
    }

    document.querySelectorAll(".wl-link").forEach((a) => {
        a.addEventListener("click", onLinkClick);
    });
})();
</script>
{% endblock %}
