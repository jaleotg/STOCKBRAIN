{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="module">
    <h2>Database Tools</h2>
    <p>These operations target the entire PostgreSQL database and are available only to superusers.</p>

    <div class="inline-group">
        <fieldset class="module aligned">
            <legend>Export entire database</legend>
            <p>
                Creates a plain SQL dump using <code>pg_dump</code>. Default destination:
                <strong>{{ default_export_path }}</strong>.
            </p>
            <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="export">
                <div class="form-row">
                    <label for="id-export-path">Destination file:</label>
                    <input id="id-export-path"
                           type="text"
                           name="export_path"
                           value="{{ default_export_path }}"
                           style="width:100%;"
                           autocomplete="off">
                </div>
                <p class="help">Directory will be created automatically if needed (current backup dir: {{ backup_dir }}).</p>
                <button type="submit" class="default">Export full database</button>
            </form>
        </fieldset>
    </div>

    <div class="inline-group">
        <fieldset class="module aligned">
            <legend>Delete &amp; Restore from file</legend>
            <p class="warning">
                Drops the entire schema and immediately restores it from the uploaded dump.
                The admin interface will be unavailable while the import is running.
            </p>
            <form method="post" action="" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="import_restore">
                <div class="form-row">
                    <label for="id-import-file">SQL dump file:</label>
                    <input id="id-import-file" type="file" name="import_file" accept=".sql" required>
                </div>
                <div class="form-row">
                    <label for="id-import-password">Confirm with your password:</label>
                    <input id="id-import-password" type="password" name="import_password" required autocomplete="off">
                </div>
                <p class="help">Supported format: plain SQL generated by <code>pg_dump</code>.</p>
                <button type="submit">Delete &amp; Restore</button>
            </form>
        </fieldset>
    </div>

    <div class="inline-group">
        <fieldset class="module aligned">
            <legend>Delete ALL data</legend>
            <p class="errornote">
                This drops the entire database schema <strong>without</strong> restoring it. The site will not work afterwards.
                You will have to restore a full dump manually from the shell.
            </p>
            <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_all">
                <div class="form-row">
                    <label for="id-pass-step1">Password (step 1):</label>
                    <input id="id-pass-step1" type="password" name="password_step1" required autocomplete="off">
                </div>
                <div class="form-row">
                    <label for="id-pass-step2">Password (step 2):</label>
                    <input id="id-pass-step2" type="password" name="password_step2" required autocomplete="off">
                </div>
                <div class="form-row">
                    <label>
                        <input type="checkbox" name="confirm_backup" required>
                        I confirm that I possess a full backup and understand the consequences.
                    </label>
                </div>
                <button type="submit" class="deletelink">Delete ALL data (irreversible)</button>
            </form>
        </fieldset>
    </div>
</div>
{% endblock %}
